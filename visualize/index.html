<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <style type="text/css">
text {
  font-size: 11px;
  pointer-events: none;
}

text.parent {
  fill: #1f77b4;
}

circle.failure{
    fill: #F5A9A9;
}

circle.success{
    fill: #9FF781;
}

circle {
  fill: #ccc;
  stroke: #999;
  pointer-events: all;
}

circle.parent {
  fill: #1f77b4;
  fill-opacity: .25;
  stroke: steelblue;
}

circle.parent:hover {
  stroke: #ff7f0e;
  stroke-width: .5px;
}

/*
circle.child {
  pointer-events: none;
}
*/

#property-panel{
  position:absolute;
  right:0px;
  top:0px;
  overflow: scroll;
  height: 100%;
  background: white;
  padding: 0px;
}

td{
  background: white;
}

table{
  table-layout: auto;
  border-collapse: collapse;
  width:100%;
}

table td.absorbing-column{
  width:100%;
}

.concept-prop{
  min-width: 110px;
}

.val-row {
  padding-left:30px !important;
}

.color-ops {
  padding-left:30px;
  padding-right:30px;
  text-align: center;
}

td.swatch{
  width: 50px;
}
</style>

<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">

<!-- jQuery library -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.2/jquery.min.js"></script>

<!-- Latest compiled JavaScript -->
<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
  </head>
  <body>
  <div class="container">
  <div class="row">
      <div id="property-panel" class="col-md-3">
        <table class="table table-condensed">
          <tbody>
            <tr>
              <td class="concept-prop"><strong>Concept Name</strong></td>
              <td class="absorbing-column" id="concept-name"></td>
            </tr>
            <tr>
              <td class="concept-prop"><strong>Size</strong></td>
              <td class="absorbing-column" id="concept-size"></td>
            </tr>
            <tr>
              <td class="concept-prop"><strong>N Children</strong></td>
              <td class="absorbing-column" id="concept-child-size"></td>
            </tr>
          </tbody>
        </table>
        <label><strong>Color By</strong>
          <select id="color-by">
            <option value="none">None</option>
          </select>
        </label><br>
        <p><strong>Attribute Type:</strong><span id="color-by-type">Default</span></p>
        <div id="nominal-colors" class="color-ops">
          <table>
            <thead>
              <tr>
                <td><strong>Value</strong></td>
                <td><strong>Color</strong></td>
              </tr>
            </thead>
            <tbody id="nom-val-colors">

            </tbody>
          </table>
        </div>
        <div id="numeric-colors" class="color-ops">
          <table>
          <thead>
            <tr>
              <td><strong>Min</strong></td>
              <td><strong>Max</strong></td>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td id="col-min-color" class="swatch"><br></td>
              <td id="col-max-color" class="swatch"><br></td>
            </tr>
            <tr>
              <td id="col-min-val"></td>
              <td id="col-max-val"></td>
            </tr>
          </tbody>
          </table>
        </div>
        <label><strong>Filter Properties</strong>
        <select id="property-filter">
            <option value="all">All</option>
            <option value="no-h">No Hidden</option>
            <option value="no-r">No Relations</option>
            <option value="no-hr">No Hidden or Relations</option>
        </select>
        </label>
        <table id="property-sheet" class="table table-bordered table-condensed">
          <thead>
            <tr>
              <td><b>Property</b></td>
              <td><b>Count</b></td>
              <td><b>Percent</b></td>
            </tr>
          </thead>
          <tbody id="properties">
          </tbody>
        </table>
      </div>
    </div>
    <div class="col-md-10">
      <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
      <script src="https://d3js.org/d3-array.v0.7.min.js"></script>
      <script src="https://d3js.org/d3-collection.v0.2.min.js"></script>
      <script src="https://d3js.org/d3-color.v0.4.min.js"></script>
      <script src="https://d3js.org/d3-format.v0.5.min.js"></script>
      <script src="https://d3js.org/d3-interpolate.v0.8.min.js"></script>
      <script src="https://d3js.org/d3-time.v0.2.min.js"></script>
      <script src="https://d3js.org/d3-time-format.v0.3.min.js"></script>
      <script src="https://d3js.org/d3-scale.v0.7.min.js"></script>
      <script type="text/javascript" src="output.js"></script>
      <script type="text/javascript">

      function parseNumeric(numeric) {
        var nm = numeric.split(" ");
        var mean = parseFloat(nm[0]);
        var std = parseFloat(nm[1].substring(1,nm[1].length-1));
        var count = parseFloat(nm[2].substring(1,nm[1].length-1));
        return {"mean":mean,"std":std,"min":mean-2*std,"max":mean+2*std,"count":count}
      }

      var attributeScales = {};
      var redGreenScale = d3_scale.scaleLinear().domain([0,1]).range(["Red","LimeGreen"]);

      //This is the base 12-class qualitative scheme from www.colorbrewer2.org
      var categoicalScale = d3_scale.scaleOrdinal().range(['#a6cee3','#1f78b4','#b2df8a','#33a02c','#fb9a99','#e31a1c','#fdbf6f','#ff7f00','#cab2d6','#6a3d9a','#ffff99','#b15928']);

      /*
       * unary - there is only 1 value and it is not numeric
       * numeric - there is only 1 value and it is a distribution
       * binary - there are only 2 values
       * nominal - there are more than 2 values
       * nominal20 - there are more than 20 values
       * unique - n(values) === n(instances) 
       *
       */
      function attributeType(rootObj,attr){
        var vals = Object.keys(rootObj['counts'][attr]);

        if(vals.length === rootObj['size']) {
          return 'unique';
        }
        if(vals.length > 10) {
          return 'nominal20';
        }
        if(vals.length > 2) {
          return 'nominal';
        }
        if(vals.length > 1) {
          return 'binary';
        }
        // 0.0000 (0.0000) [2]
        var patt = /\d+\.\d+\s\(\d+\.\d+\)\s\[\d+\]/g;
        if(patt.test(vals[0])) {
          return "numeric";
        }
        else {
          return "unique";
        }
      }      

      function setupAttributes(rootObj) {
        var attrs = Object.keys(rootObj['counts']);
        for (var i = 0; i < attrs.length; i ++) {
          var attr = attrs[i];
          var vals = Object.keys(rootObj['counts'][attr]);
          vals.sort();
          vals.reverse();
          var attType = attributeType(rootObj,attr);
          var scal = {"type":attType,"scale":null};
          if (attType === "nominal") {
            scal.scale = d3_scale.scaleCategory10();
          }
          else if (attType === "nominal20") {
            scal.scale = d3_scale.scaleCategory20();
          }
          else if (attType === "binary") {
            scal.scale = redGreenScale; //d3_scale.scalePlasma();
          }
          else if (attType === "numeric") {
            var num = parseNumeric(vals[0]);
            scal.scale = redGreenScale.copy().domain([num.min,num.max]);
          }
          attributeScales[attr] = scal;
        }
      }


      var w = 1280,
          //h = 800,
          h = window.innerHeight,
          r = 720,
          x = d3.scale.linear().range([0, r]),
          y = d3.scale.linear().range([0, r]),
          node,
          root;

      var pack = d3.layout.pack()
          .size([r, r])
          .value(function(d) { return d.size; })

      var vis = d3.select("body").insert("svg:svg", "h2")
          .attr("width", w)
          .attr("height", h)
          .append("svg:g")
          .attr("transform", "translate(" + (w - r) / 2 + "," + (h - r) / 2 + ")");

          var data = output;
         // console.log(hackObj);

      //d3.json(output, function(data) {
        node = root = data;

      function buildTree(images=false,names=false) {
        var nodes = pack.nodes(root);

        vis.selectAll("circle")
        .data(nodes)
          .enter().append("svg:circle")
            .attr("id", function(d) { return d.name; })
            .attr("class", function(d) { return d.children ? "parent" : "child"; })
            .attr("cx", function(d) { return d.x; })
            .attr("cy", function(d) { return d.y; })
            .attr("r", function(d) { return d.r; })
            .on("click", function(d) { return zoom(node == d ? root : d); });
            //.style("opacity", function(d) { return (d.r > 100) ? 1 : 0; });

        if(images){
          vis.selectAll("image.tower")
          .data(nodes.filter(function(d){
                  if (d.children || !d.guid){ 
                    return false; 
                  } else {
                    return true;
                  }}))
            .enter().append("image")
                .attr('class', 'tower')
                .attr("xlink:href", function(d) { return "images/" + d.guid +
                        ".png"})
            .attr("width", function(d) { return (1.33 * d.r); })
            .attr("height", function(d) { return d.r; })
            .attr("x", function(d) { return d.x - ((1.33 * d.r)/2); })
            .attr("y", function(d) { return d.y - (d.r/2); });
        }
        vis.selectAll("text")
            .data(nodes)
            .enter().append("svg:text")
            .attr("class", function(d) { return d.children ? "parent" : "child"; })
            .attr("x", function(d) { return d.x; })
            .attr("y", function(d) { return d.y; })
            .attr("dy", ".35em")
            .attr("text-anchor", "middle")
            //.style("opacity", function(d) { return (d.r > 100 && d.r < 200) ? 1 : 0; })
            .text(function(d) { 
                  //return "";
                  if(names){
                   return d.name;
                  }
                  else {
                    return "";
                  }
                  guid = "";
                  if (d.counts['has-guid = 1']){
                      console.log(d.counts);
                      guid = "X";
                  }
                  if (!d.children && d.counts['success = 1'] > 0 && 
                        !d.counts['success = 0']){
                      return "S " + guid;
                  }
                  else if (!d.children && d.counts['success = 0'] > 0 &&
                      !d.counts['success = 1']){
                      return "F " + guid;
                  }
                  else if (!d.children && d.counts['success = 0'] > 0 &&
                      d.counts['success = 1'] > 0){
                  return "S = " + (d.counts['success = 1'] / (d.counts['success = 1']
                          + d.counts['success = 0'])) + guid;
                  }
                  });

        d3.select(window).on("click", function() { zoom(root); });
      //});
      }

      function majorityValue(table) {
        var values = Object.keys(table);
        values.sort();
        values.reverse();
        var maj = {"n":"","v":0};
        for (var i = 0; i < values.length; i++) {
          if(table[values[i]] > maj.v){
            maj.n = values[i];
            maj.v = table[values[i]];
          }
        }
        return maj.n;
      }

      function binaryRatio(table) {
        var values = Object.keys(table);
        values.sort();
        values.reverse();
        return table[values[0]]/(table[values[0]]+table[values[1]]);
      }

      function recolor(d) {
        var targetAttr = $("#color-by").val();
        var scale = attributeScales[targetAttr];
        if(!scale){
          return;
        }
        var circle = $("#"+d.name);

        if (scale.type === "unary" || scale.type === "unique"){
          if(d.children) {
            circle.css("fill","#1f77b4");
          }
          else {
            circle.css("fill","#cccccc");
          }
        }
        else if (scale.type === "nominal20" || scale.type === "nominal") {
          console.log(d);
          circle.css("fill",scale.scale(majorityValue(d['counts'][targetAttr])));
        }
        else if (scale.type === "binary") {
          circle.css("fill",scale.scale(binaryRatio(d['counts'][targetAttr])));
        }
        else if (scale.type === "numeric") {
          var num = parseNumeric(Object.keys(d['counts'][targetAttr])[0]);
          circle.css("fill",scale.scale(num.mean));
        }
        for(var child in d.children){
          recolor(d.children[child]);
        }

      }

      function zoom(d, i) {
        //console.log(d);
        make_property_sheet(d);

        scale = 1.0;
        //console.log(d.CU)
        //console.log(d.counts)
        var k = r / d.r / 2;
        x.domain([d.x - d.r, d.x + d.r]);
        y.domain([d.y - d.r, d.y + d.r]);

        var t = vis.transition()
            .duration(d3.event.altKey ? 7500 : 750);

        t.selectAll("image.tower")
            .attr("width", function(d) { return (scale * 1.33 * k * d.r); })
            .attr("height", function(d) { return scale * k * d.r; })
            .attr("x", function(d) { return scale * (x(d.x) - ((1.33 * k * d.r)/2)); })
            .attr("y", function(d) { return scale * (y(d.y) - ((k * d.r)/2)); });

        t.selectAll("circle")
            .attr("cx", function(d) { return scale * x(d.x); })
            .attr("cy", function(d) { return scale * y(d.y); })
            .attr("r", function(d) { return scale * k * d.r; });
            //.style("opacity", function(d) { return (k * d.r > 100) ? 1 : 0; });

        t.selectAll("text")
            .attr("x", function(d) { return scale * x(d.x); })
            .attr("y", function(d) { return scale * y(d.y); })
            //.style("opacity", function(d) { return (k * d.r > 100 && k * d.r < 200) ? 1 : 0; });

        node = d;
        d3.event.stopPropagation();
      }

      function populateColorByOptions(d) {
        var attrs = Object.keys(d['counts']);
        attrs.sort();
        attrs.reverse();

        var colorBy = document.getElementById("color-by");

        for (var i=0; i < attrs.length;i++){
          var opt = document.createElement('option');
          opt.setAttribute("value",attrs[i]);
          opt.innerHTML=attrs[i]
          colorBy.appendChild(opt);
        }
        colorBy.addEventListener("changed",colorSelectChanged);
      }

      function colorSelectChanged() {
        var attr = $("#color-by").val();
        if(attr === "none"){
          $("#color-by-type").text("Default");
          $(".color-ops").hide();
        }
        else {
          var attrScale = attributeScales[attr];
          if(attrScale.type === "unique") {
            $("#color-by-type").text("Unique");
          }
          else if(attrScale.type === "unary") {
            $("#color-by-type").text("Unary"); 
          }
          if(attrScale.type ==="nominal" || attrScale.type === "nominal20"){
            $("#color-by-type").text("Nominal");
            var colorTable = document.getElementById("nom-val-colors");
            colorTable.innerHTML = "";
            var vals = Object.keys(data['counts'][attr]);
            vals.sort();
            vals.reverse();
            for(i=0;i<vals.length;i++) {
              var tr = document.createElement('tr');
              var valName = document.createElement('td');
              valName.innerHTML = vals[i];
              tr.appendChild(valName);
              var colorCell = document.createElement('td');
              colorCell.class += "swatch";
              colorCell.style = "background-color: "+ attrScale.scale(vals[i]);
              tr.appendChild(colorCell);

              colorTable.appendChild(tr);  
            }
            $("#numeric-colors").hide();
            $("#nominal-colors").show();
          }
          else if (attrScale.type ==="numeric"){
            $("#color-by-type").text("Numeric");
            $("#col-min-val").text(attrScale.scale.domain()[0].toFixed(3));
            $("#col-min-color").css("background-color",attrScale.scale.range()[0]);
            $("#col-max-val").text(attrScale.scale.domain()[1].toFixed(3));
            $("#col-max-color").css("background-color",attrScale.scale.range()[1]);
            $("#numeric-colors").show();
            $("#nominal-colors").hide();
          }
          else {
            console.error("unknown attribute type found");
            console.log(data);
          }
        }
        recolor(data);
      }

      function make_property_sheet(node_data) {
        d = node_data['counts']
        var property_sheet = document.getElementById('properties');//$('#properties');
        var prop_filter = document.getElementById('property-filter');//
        property_sheet.innerHTML = '';

        $("#concept-name").text(node_data['name'])
        $("#concept-size").text(node_data['size'])
        var n_children = node_data['children'] ? node_data['children'].length : 0;
        $("#concept-child-size").text(n_children)

        var d_keys = Object.keys(d);
        var attrs = []
        for (var i = 0; i < d_keys.length; i++){
          switch(prop_filter.value){
            case "all":
              attrs.push(d_keys[i])
              break;
            case "no-h":
              if(d_keys[i][0] !== "_") {
                attrs.push(d_keys[i])
              }
              break;
            case "no-r":
              if(d_keys[i][0] !== "(") {
                attrs.push(d_keys[i])
              }
              break;
            case "no-hr":
              if (d_keys[i][0] !== "_" && d_keys[i][0] !== "("){
                attrs.push(d_keys[i])
              }
              break;
          }
        }
        attrs.sort();
        attrs.reverse();


        for (var a in attrs) {
          attr = attrs[a]
          var tr = document.createElement('tr');
          var ad = document.createElement('td');
          ad.appendChild(document.createTextNode(attr));
          tr.appendChild(ad);
          tr.className += " info";
          tr.appendChild(document.createElement('td'));
          tr.appendChild(document.createElement('td'));
          property_sheet.appendChild(tr);

          vals = Object.keys(d[attr]);
          vals.sort();
          vals.reverse();

          for (var v in vals){
            val = vals[v];
           
            tr = document.createElement('tr');
            var vd = document.createElement('td');
            vd.appendChild(document.createTextNode(val.split('[')[0]));
            vd.className += " val-row";
            tr.appendChild(vd);
            var cd = document.createElement('td');
            var pd = document.createElement('td');
            var count = d[attr][val]
            var perc = count/node_data['size']*100;
            cd.innerHTML=count;
            pd.innerHTML=perc.toFixed(2) +"%";
            tr.appendChild(cd);
            tr.appendChild(pd);
            property_sheet.appendChild(tr);
          }
        }
      }
      $( "#color-by" ).change( colorSelectChanged );
      colorSelectChanged();
      setupAttributes(data);
      populateColorByOptions(data);
      buildTree();
      make_property_sheet(data);
      </script>
    </div>


    </div>
  </body>
</html>

